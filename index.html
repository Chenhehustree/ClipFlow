<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClipFlow | Smart Clipboard Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        /* Base Settings */
        :root {
            --font-inter: 'Inter', sans-serif;
        }
        body {
            font-family: var(--font-inter);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #e4e4e7;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #d4d4d8;
        }

        /* Text Clamping for Collapse */
        .text-clamped {
            display: -webkit-box;
            -webkit-line-clamp: 4; /* Show max 4 lines */
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Custom Input Focus Ring Animation */
        .focus-ring-anim {
            transition: box-shadow 0.2s ease, border-color 0.2s ease;
        }

        /* Smooth layout transitions (Applied to grid items) */
        .grid-item-transition {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Custom Styles for Editing State */
        .editing-mode {
            background-color: #f0fdf4 !important; /* Tailwind: bg-emerald-50 */
            border-color: #d1fae5 !important; /* Tailwind: border-emerald-200 */
        }
    </style>
</head>
<body class="bg-zinc-50 text-zinc-900 min-h-screen flex flex-col items-center py-10 px-4 sm:px-6 lg:px-8">

    <div class="w-full max-w-5xl space-y-8 mb-10">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="p-2.5 bg-zinc-900 rounded-xl text-white shadow-lg shadow-zinc-900/10">
                    <i data-lucide="layers" class="w-5 h-5"></i>
                </div>
                <h1 class="text-xl font-medium tracking-tight text-zinc-900">ClipFlow.</h1>
            </div>
            <div class="text-xs font-medium text-zinc-500 bg-white px-3 py-1.5 rounded-full border border-zinc-200 shadow-sm">
                <span id="count-display">0</span> Items
            </div>
        </div>

        <div class="relative group">
            <div class="absolute inset-0 bg-gradient-to-r from-zinc-200 via-zinc-100 to-zinc-200 rounded-2xl blur opacity-30 group-hover:opacity-50 transition duration-700"></div>
                <div id="input-container" class="relative bg-white rounded-2xl border border-zinc-200 shadow-sm overflow-hidden focus-within:ring-2 focus-within:ring-zinc-900/5 focus-within:border-zinc-300 focus-ring-anim transition-shadow hover:shadow-md transition-all duration-300">
                <textarea 
                    id="input-text" 
                    placeholder="Paste or type your content here..." class="w-full h-28 p-6 resize-none outline-none text-base text-zinc-700 placeholder:text-zinc-400 bg-transparent leading-relaxed"
                ></textarea>
                <div class="flex items-center justify-between px-5 py-3 border-t border-zinc-50 bg-zinc-50/80">
                    <span class="text-xs text-zinc-400 flex items-center gap-1.5 font-medium">
                        <i data-lucide="keyboard" class="w-3.5 h-3.5"></i>
                        <span>Cmd/Ctrl + V to paste</span> </span>
                                    <button onclick="addNote()" id="add-update-btn" class="flex items-center gap-2 px-4 py-2 bg-zinc-900 hover:bg-zinc-800 text-white text-xs font-medium rounded-lg transition-all active:scale-95 shadow-sm hover:shadow-md">
                        <i data-lucide="plus" class="w-3.5 h-3.5" id="add-update-icon"></i>
                        <span id="add-update-text">Add Note</span> </button>
                </div>
            </div>
        </div>
    </div>

    <div id="notes-container" class="w-full max-w-5xl grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 pb-20 items-start">
        </div>

    <div id="empty-state" class="hidden flex-col items-center justify-center py-24 text-center space-y-5">
        <div class="w-16 h-16 bg-white border border-zinc-200 rounded-2xl flex items-center justify-center text-zinc-300 shadow-sm">
            <i data-lucide="clipboard-list" class="w-8 h-8"></i>
        </div>
        <div>
            <h3 class="text-lg font-medium tracking-tight text-zinc-900">No clips yet</h3>
            <p class="text-sm text-zinc-500 mt-2 max-w-xs mx-auto leading-relaxed">Copy text from anywhere and paste it here, or type a new note to get started.</p>
        </div>
        
    </div>

    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 flex items-center gap-3 px-5 py-3 bg-zinc-900 text-white rounded-full shadow-xl transform translate-y-24 opacity-0 transition-all duration-400 z-50">
        <i data-lucide="check-circle-2" class="w-4 h-4 text-emerald-400"></i>
        <span class="text-sm font-medium" id="toast-message">Action successful</span>
    </div>

    <script>
        const STORAGE_KEY = 'clipflow_notes';

        // Initial default data if localStorage is empty
        const defaultNotes = [
            {
                id: 1,
                // 修复 2: 替换为英文内容
                content: "Tailwind CSS is a utility-first CSS framework packed with classes like flex, pt-4, text-center and rotate-90 that can be composed to build any design, directly in your markup. It allows for rapid UI development without leaving your HTML.",
                date: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                expanded: false
            },
            {
                id: 2,
                // 修复 2: 替换为英文内容
                content: "Design is not just what it looks like and feels like. Design is how it works. - Steve Jobs. This quote emphasizes functionality over pure aesthetics.",
                date: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                expanded: false
            },
            {
                id: 3,
                // 修复 2: 替换为英文内容
                content: "function calculateFactorial(n) {\n  if (n === 0 || n === 1) return 1;\n  return n * calculateFactorial(n - 1);\n}\n\n// Recursive solution for calculating factorial in JavaScript. This function calls itself until it reaches the base case.",
                date: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                expanded: true
            },
            {
                id: 4,
                // 修复 2: 替换为英文内容
                content: "Meeting notes: \n1. Discuss Q4 roadmap \n2. Review budget allocation \n3. Team building event ideas. \n\nNeed to follow up with Sarah regarding the design assets by Friday. Don't forget to check the new linear gradient updates in the design system.",
                date: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                expanded: false
            }
        ];

        // State Management - Load from localStorage or use defaults
        let notes = loadNotes();
        let editingNoteId = null; // Track the ID of the note currently being edited

        // DOM Elements
        const container = document.getElementById('notes-container');
        const input = document.getElementById('input-text');
        const emptyState = document.getElementById('empty-state');
        const countDisplay = document.getElementById('count-display');
        const toast = document.getElementById('toast');
        const toastMsg = document.getElementById('toast-message');
        const inputContainer = document.getElementById('input-container');
        const addUpdateText = document.getElementById('add-update-text');
        
        // --- Persistence Functions ---

        /**
         * Loads notes from localStorage.
         */
        function loadNotes() {
            try {
                const storedNotes = localStorage.getItem(STORAGE_KEY);
                if (storedNotes) {
                    // Parse stored data. Ensure 'expanded' property is present.
                    const parsedNotes = JSON.parse(storedNotes);
                    return parsedNotes.map(note => ({
                        ...note,
                        expanded: note.expanded || false // Default to false if missing
                    }));
                }
            } catch (error) {
                console.error("Error loading notes from localStorage:", error);
            }
            return defaultNotes;
        }

        /**
         * Saves the current notes state to localStorage.
         */
        function saveNotes() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(notes));
            } catch (error) {
                console.error("Error saving notes to localStorage:", error);
            }
        }

        // --- Core Functions ---

        // Render Function
        function render() {
            container.innerHTML = '';
            countDisplay.innerText = notes.length;

            // Update input button state based on editingNoteId
            if (editingNoteId) {
                addUpdateText.innerText = 'Update Note';
                inputContainer.classList.add('editing-mode');
                inputContainer.classList.add('ring-emerald-400/50');
            } else {
                addUpdateText.innerText = 'Add Note';
                inputContainer.classList.remove('editing-mode');
                inputContainer.classList.remove('ring-emerald-400/50');
            }


            if (notes.length === 0) {
                emptyState.classList.remove('hidden');
                emptyState.classList.add('flex');
            } else {
                emptyState.classList.add('hidden');
                emptyState.classList.remove('flex');
            }

            // Using Grid Layout Logic
            [...notes].reverse().forEach(note => {
                const isLong = note.content.length > 120 || (note.content.match(/\n/g) || []).length > 3;
                
                // Grid Span Logic for Expanded Items
                const colSpanClass = note.expanded 
                    ? 'col-span-1 sm:col-span-2 lg:col-span-3' 
                    : 'col-span-1';

                // FIX 1: Added 'flex flex-col' here to ensure card contents stack vertically correctly in Grid.
                const cardBaseClass = `group relative flex flex-col bg-white border border-zinc-200 rounded-xl p-6 shadow-[0_2px_8px_-2px_rgba(0,0,0,0.05)] hover:shadow-[0_8px_24px_-4px_rgba(0,0,0,0.08)] transition-all duration-300 ease-out hover:-translate-y-0.5 grid-item-transition ${colSpanClass} ${note.id === editingNoteId ? 'editing-mode' : ''}`;
                
                const card = document.createElement('div');
                card.className = cardBaseClass;
                card.id = `card-${note.id}`;
                
                const contentClass = note.expanded ? '' : 'text-clamped';
                const expandBtnText = note.expanded ? 'Show less' : 'Show more'; // 修复 1: 确保文本是英文
                const expandBtnIcon = note.expanded ? 'minimize-2' : 'chevron-down';
                const actionFunc = `toggleExpand(${note.id})`;

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4 relative">
                        <span class="text-[11px] font-medium tracking-wide text-zinc-400 bg-zinc-50 px-2.5 py-1 rounded-md border border-zinc-100">${note.date}</span>
                        
                        <div class="flex gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                            <button onclick="copyToClipboard('${note.id}')" class="p-1.5 text-zinc-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Copy to Clipboard">
                                <i data-lucide="check-square" class="w-3.5 h-3.5"></i>
                            </button>
                                
                            <button onclick="editNote(${note.id})" class="p-1.5 text-zinc-400 hover:text-orange-600 hover:bg-orange-50 rounded-lg transition-colors" title="Edit Note">
                                <i data-lucide="pencil-line" class="w-3.5 h-3.5"></i>
                            </button>

                            <button onclick="deleteNote(${note.id})" class="p-1.5 text-zinc-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Delete">
                                <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                            </button>
                        </div>
                    </div>
                    
                                        <div class="relative w-full flex-grow">
                        <p class="text-base text-zinc-600 leading-7 whitespace-pre-wrap break-words font-normal ${contentClass}" id="text-${note.id}" onmouseup="window.getSelection().removeAllRanges()" ontouchend="window.getSelection().removeAllRanges()">${escapeHtml(note.content)}</p>
                        ${isLong && !note.expanded ? '<div class="absolute bottom-0 left-0 w-full h-12 bg-gradient-to-t from-white via-white/80 to-transparent pointer-events-none"></div>' : ''}
                    </div>

                    ${isLong ? `
                    <div class="flex items-center justify-between mt-4 pt-2">
                        <button onclick="${actionFunc}" class="flex items-center gap-1.5 text-xs font-medium text-zinc-500 hover:text-zinc-900 transition-colors focus:outline-none py-1 px-2 -ml-2 rounded-md hover:bg-zinc-50">
                            <span>${expandBtnText}</span>
                            <i data-lucide="${expandBtnIcon}" class="w-3 h-3"></i>
                        </button>
                    </div>
                    ` : ''}
                `;
                
                container.appendChild(card);
            });
            
            // Re-initialize icons with thinner stroke
            lucide.createIcons({
                attrs: {
                    'stroke-width': '1.5'
                }
            });
        }

        // Add/Update Note
        function addNote() {
            const text = input.value.trim();
            if (!text) return;

            if (editingNoteId) {
                // --- Update Logic ---
                const noteIndex = notes.findIndex(n => n.id === editingNoteId);
                if (noteIndex > -1) {
                    notes[noteIndex].content = text;
                    notes[noteIndex].date = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    notes[noteIndex].expanded = false; // Collapse upon update
                    showToast('Note updated successfully');
                }
                editingNoteId = null; // Exit editing mode
            } else {
                // --- Add New Logic ---
                const newNote = {
                    id: Date.now(),
                    content: text,
                    date: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                    expanded: false
                };
                notes.push(newNote);
                showToast('Note added successfully');
            }

            input.value = '';
            saveNotes(); // Persist data
            render();
        }

        // Edit Note
        function editNote(id) {
            const note = notes.find(n => n.id === id);
            if (!note) return;

            // 1. Set the note content to the input field
            input.value = note.content;
            
            // 2. Store the ID of the note being edited
            editingNoteId = id;

            // 3. Scroll to the top and focus the input for easy editing
            window.scrollTo({ top: 0, behavior: 'smooth' });
            input.focus();

            // 4. Update the UI to reflect editing mode
            render(); 
        }

        // Delete Note
        function deleteNote(id) {
            notes = notes.filter(note => note.id !== id);
            if (editingNoteId === id) {
                // If the deleted note was being edited, clear the input
                input.value = '';
                editingNoteId = null;
            }
            saveNotes(); // Persist data
            render();
            showToast('Note deleted');
        }

        // Toggle Expand/Collapse
        function toggleExpand(id) {
            const noteIndex = notes.findIndex(n => n.id === id);
            if (noteIndex > -1) {
                notes[noteIndex].expanded = !notes[noteIndex].expanded;
                saveNotes(); // Save expansion state
                render(); 
            }
        }

        // Copy Functionality
        async function copyToClipboard(id) {
            const note = notes.find(n => n.id == id);
            if (!note) return;
            
            try {
                // Use modern Clipboard API for reliable copy
                await navigator.clipboard.writeText(note.content);
                showToast('Copied to clipboard');
            } catch (err) {
                // Fallback for older browsers or security blocks
                console.error('Failed to use Clipboard API:', err);
                const textArea = document.createElement("textarea");
                textArea.value = note.content;
                textArea.style.position = "fixed"; 
                textArea.style.left = "-999999px"; 
                textArea.style.top = "-999999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast('Copied to clipboard (Fallback)');
                } catch (e) {
                    showToast('Failed to copy');
                }
                document.body.removeChild(textArea);
            }
        }

        // Toast Notification Logic
        let toastTimeout;
        function showToast(message) {
            toastMsg.innerText = message;
            toast.classList.remove('translate-y-24', 'opacity-0');
            
            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                toast.classList.add('translate-y-24', 'opacity-0');
            }, 2500);
        }

        // Escape HTML for security
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            // Use replace with a function for all matches
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // Listen for Ctrl/Cmd + Enter to submit
        input.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault(); // Prevent default new line
                addNote();
            }
        });

        // Listen for Escape key to exit editing mode
        input.addEventListener('keyup', (e) => {
            if (e.key === 'Escape' && editingNoteId) {
                editingNoteId = null;
                input.value = '';
                render();
            }
        });

        // Initialize
        render();

    </script>
</body>
</html>